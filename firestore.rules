rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() && (request.auth.token.email == 'shengliang.song.ai@gmail.com');
    }

    // ----------------------------------------------------------------------
    // SIGNET IDENTITY REGISTRY (TKS)
    // ----------------------------------------------------------------------
    match /identities/{anchorId} {
      // Public lookup is required for global verification
      allow read: if true;
      
      // First-to-Claim: Only allow creation if the anchor doesn't exist.
      allow create: if !exists(/databases/$(database)/documents/identities/$(anchorId));
      
      // Update and delete are restricted to administrators for revocation/governance
      allow update, delete: if isAdmin();
    }

    // ----------------------------------------------------------------------
    // Global Admin Override
    // ----------------------------------------------------------------------
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // ----------------------------------------------------------------------
    // NEURAL CACHE & LEDGERS (Shared Knowledge Plane)
    // ----------------------------------------------------------------------
    match /neural_audio_ledger/{allPaths=**} {
      allow read: if true; 
      allow write: if isAuthenticated(); 
    }

    match /lecture_cache/{allPaths=**} {
      allow read: if true; 
      allow write: if isAuthenticated(); 
    }

    match /bible_ledger/{allPaths=**} {
      allow read: if true; 
      allow write: if isAuthenticated(); 
    }

    // ----------------------------------------------------------------------
    // USERS & IDENTITY
    // ----------------------------------------------------------------------
    match /users/{userId} {
      allow read: if isAuthenticated(); 
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin(); 
    }

    // ----------------------------------------------------------------------
    // TRANSACTIONS & ESCROW
    // ----------------------------------------------------------------------
    match /invitations/{inviteId} { 
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
    }
    
    match /receipts/{receiptId} { 
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
    }

    match /coin_transactions/{txId} { 
      allow read: if isAuthenticated(); 
      allow create: if isAuthenticated(); 
    }

    // ----------------------------------------------------------------------
    // COMMUNITY & CONTENT
    // ----------------------------------------------------------------------
    match /blogs/{blogId} {
      allow read: if true;
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    match /blog_posts/{postId} {
      allow read: if true;
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    match /channels/{channelId} {
      allow read: if true; 
      allow create: if isAuthenticated();
      allow update: if isAdmin() || isAuthenticated();
      allow delete: if isAdmin();
    }
    
    match /channel_stats/{id} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /chat_channels/{channelId} {
      allow read, write: if isAuthenticated();
      match /messages/{msgId} { allow read, write: if isAuthenticated(); }
    }
    
    match /discussions/{discussionId} { 
      allow read: if true; 
      allow write: if isAuthenticated(); 
    }
    
    match /mock_interviews/{interviewId} { 
      allow read: if isAuthenticated(); 
      allow write: if isAuthenticated(); 
    }
    
    match /custom_books/{bookId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /system_book_metadata/{bookId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /badges/{badgeId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ----------------------------------------------------------------------
    // APPLICATIONS & WORKSPACES
    // ----------------------------------------------------------------------
    match /groups/{groupId} { 
      allow read, write: if isAuthenticated(); 
      match /messages/{msgId} { allow read, write: if isAuthenticated(); }
    }

    match /code_projects/{projectId} { 
      allow read, write: if isAuthenticated(); 
      match /cursors/{clientId} { allow read, write: if isAuthenticated(); }
    }

    match /user_cloud_files/{fileId} {
      allow read, write: if isAuthenticated();
    }

    match /whiteboards/{boardId} { 
      allow read, write: if isAuthenticated(); 
    }

    match /job_postings/{jobId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /career_applications/{appId} {
      allow read, write: if isAuthenticated();
    }

    match /signed_documents/{docId} {
      // Must be public read for 3rd party verification links
      allow read: if true;
      allow write: if isAuthenticated();
    }

    match /global_stats/{statId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    match /activity_logs/{logId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
    }

    // ----------------------------------------------------------------------
    // STANDARD COLLECTIONS
    // ----------------------------------------------------------------------
    match /bookings/{bookingId} { allow read, write: if isAuthenticated(); }
    match /recordings/{recordingId} { allow read, write: if isAuthenticated(); }
    match /checks/{checkId} { allow read: if true; allow write: if isAuthenticated(); }
    match /shipping/{labelId} { allow read, write: if isAuthenticated(); }
    match /icons/{iconId} { allow read, write: if isAuthenticated(); }
    match /cards/{cardId} { allow read, write: if isAuthenticated(); }
    match /notebooks/{notebookId} { allow read, write: if isAuthenticated(); }
    match /feedback/{feedbackId} { allow read, write: if isAuthenticated(); }
  }
}